{% extends "core/base.html" %}
{% load widget_tweaks %}
{% block title %}Оставить заявку — Drop & Delivery{% endblock %}
{% block content %}
<div class="row justify-content-center py-5">
  <div class="col-lg-6 col-md-8">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <h2 class="mb-3 text-center fw-bold">Оставить заявку</h2>

        <!-- Баннер зоны работы -->
        <div class="alert alert-info d-flex gap-2 align-items-start rounded-3 mb-4" role="alert">
          <i class="bi bi-geo-alt fs-5"></i>
          <div>
            <strong>Работаем только в Москве и Московской области.</strong><br>
            Также доставляем в/из аэропортов: Шереметьево, Внуково, Домодедово, Жуковский.
          </div>
        </div>

        <form method="post" autocomplete="off" id="orderForm">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <style>
            .form-control::placeholder{color:#9aa6b2;opacity:1}
            .req::after{content:" *"; color:#ef4444; font-weight:600}

            .dtl-wrap{position:relative}
            .dtl-wrap .fake-ph{
              position:absolute;left:12px;top:50%;transform:translateY(-50%);
              color:#9aa6b2;pointer-events:none;transition:opacity .18s ease;
              font-size:1rem;line-height:1
            }
            .dtl-wrap input.form-control{padding-right:1.9rem}
            .dtl-wrap input[type="datetime-local"]::-webkit-calendar-picker-indicator{
              transform:translateX(-8px);cursor:pointer;
            }
            .dtl-wrap.filled .fake-ph,.dtl-wrap.focused .fake-ph{opacity:0}
            .is-invalid{border-color:#ef4444 !important; box-shadow:0 0 0 .15rem rgba(239,68,68,.15) !important}
            .invalid-hint{color:#ef4444;font-size:.875rem;margin-top:.25rem;display:none}
            .invalid-hint.show{display:block}

            .dd-calc .qty{
              display:flex;align-items:center;gap:8px;width:240px;max-width:100%;
              background:#fff;border:1px solid #e5e7eb;border-radius:14px;
              padding:6px;box-shadow:0 1px 2px rgba(0,0,0,.03)
            }
            .dd-calc .qty input{
              border:0;text-align:center;flex:1 1 auto;font-weight:600;font-size:1.05rem;
              padding:.35rem 0;background:transparent;outline:none
            }
            .dd-calc .qty input::-webkit-outer-spin-button,.dd-calc .qty input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
            .dd-calc .qty input[type=number]{-moz-appearance:textfield}
            .dd-calc .qty .qty-btn{
              border:0;background:#f1f5f9;width:36px;height:36px;line-height:36px;
              border-radius:10px;font-weight:700;font-size:1.1rem;cursor:pointer
            }
            .dd-calc .qty .qty-btn:hover{background:#e2e8f0}

            /* --- Согласия рядом --- */
            .consents-inline {
              display: flex;
              flex-wrap: wrap;
              align-items: center;
              gap: 1.5rem;
              justify-content: center;
              margin-top: 1rem;
            }
            .consents-inline .form-check {
              margin: 0;
              padding: 0;
              display: flex;
              align-items: center;
            }
            .consents-inline .form-check-label {
              margin-left: .4rem;
            }
          </style>

          <div class="row g-3">
            <!-- Контакты -->
            <div class="col-12">
              <label for="id_name" class="form-label req"><i class="bi bi-person-circle"></i> Имя</label>
              {{ form.name|add_class:"form-control"|attr:"placeholder:Иван Иванов"|attr:"required:required" }}
              <div class="invalid-hint" data-hint-for="id_name">Укажите имя.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="id_phone" class="form-label req"><i class="bi bi-telephone"></i> Телефон</label>
              {{ form.phone|add_class:"form-control"|attr:"placeholder:+7 900 000-00-00"|attr:"required:required" }}
              <div class="invalid-hint" data-hint-for="id_phone">Укажите телефон.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="id_email" class="form-label req"><i class="bi bi-envelope"></i> Email</label>
              {{ form.email|add_class:"form-control"|attr:"placeholder:you@example.com"|attr:"type:email"|attr:"required:required" }}
              <div class="invalid-hint" data-hint-for="id_email">Укажите корректный email.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="id_telegram" class="form-label"><i class="bi bi-telegram"></i> Telegram</label>
              {{ form.telegram|add_class:"form-control"|attr:"placeholder:@username" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_whatsapp" class="form-label"><i class="bi bi-whatsapp"></i> WhatsApp</label>
              {{ form.whatsapp|add_class:"form-control"|attr:"placeholder:+7 900 000-00-00" }}
            </div>

            <!-- Логистика -->
            <div class="col-12 mt-2">
              <label for="id_pickup_address" class="form-label req"><i class="bi bi-geo-alt"></i> Адрес забора</label>
              {{ form.pickup_address|add_class:"form-control"|attr:"placeholder:Адрес / аэропорт / вокзал"|attr:"required:required" }}
              <div id="pickup_warn" class="text-danger small mt-1 d-none">Мы работаем только в Москве и МО.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="id_pickup_time" class="form-label req"><i class="bi bi-calendar-event"></i> Время забора</label>
              <div class="dtl-wrap" id="wrap_pickup">
                {{ form.pickup_time|add_class:"form-control"|attr:"type:datetime-local"|attr:"required:required" }}
                <span class="fake-ph">дата / время</span>
              </div>
            </div>

            <div class="col-12">
              <label for="id_delivery_address" class="form-label req"><i class="bi bi-geo"></i> Адрес доставки</label>
              {{ form.delivery_address|add_class:"form-control"|attr:"placeholder:Адрес / аэропорт / вокзал"|attr:"required:required" }}
              <div id="delivery_warn" class="text-danger small mt-1 d-none">Мы работаем только в Москве и МО.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="id_delivery_time" class="form-label req"><i class="bi bi-calendar-event"></i> Время доставки</label>
              <div class="dtl-wrap" id="wrap_delivery">
                {{ form.delivery_time|add_class:"form-control"|attr:"type:datetime-local"|attr:"required:required" }}
                <span class="fake-ph">дата / время</span>
              </div>
            </div>

            {% if form.items_count %}
            <div class="col-12 col-md-6">
              <label for="id_items_count" class="form-label"><i class="bi bi-suitcase"></i> Единиц багажа</label>
              {{ form.items_count|add_class:"form-control"|attr:"min:1" }}
            </div>
            {% endif %}

            <!-- Калькулятор -->
            <div class="col-12">
              <div class="dd-calc card border-0 rounded-3 p-3" style="background:#f8fafc;border:1px solid #e5e7eb!important">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-calculator me-2"></i>
                  <strong class="h6 mb-0">Калькулятор заказа</strong>
                </div>

                <div class="row g-3 align-items-center">
                  <div class="col-12 col-md-5">
                    <label class="form-label text-muted small mb-1">Единиц багажа</label>
                    <div class="qty">
                      <button class="qty-btn" type="button" id="itemsMinus" aria-label="Уменьшить">−</button>
                      <input id="order-items" type="number" value="1" min="1" max="99" inputmode="numeric">
                      <button class="qty-btn" type="button" id="itemsPlus" aria-label="Увеличить">+</button>
                    </div>
                  </div>
                  <div class="col-12 col-md-7">
                    <label class="form-label text-muted small mb-1">Зона</label>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <span id="zonePill" class="badge rounded-pill bg-success-subtle text-success-emphasis px-3 py-2">Зона 1 (×1.0)</span>
                      <span class="text-muted small" id="zoneNote">по умолчанию</span>
                    </div>
                    <input type="hidden" name="zone_coef" id="zone_coef" value="1.0">
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center border rounded-3 px-3 py-2 bg-white">
                      <div class="text-muted">Итоговая стоимость</div>
                      <div id="order-total" class="fw-bold">0 ₽</div>
                    </div>
                    <input type="hidden" name="estimated_cost" id="estimated_cost" value="0">
                  </div>
                </div>
              </div>
            </div>

            <!-- Комментарий -->
            <div class="col-12">
              <label for="id_comment" class="form-label"><i class="bi bi-chat-dots"></i> Комментарий</label>
              {{ form.comment|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:Пожелания, доп.комментарии..." }}
            </div>
          </div>

<!-- Согласия рядом, выравнивание слева -->
<style>
  .consents-inline {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.5rem;
    justify-content: flex-start; /* выравниваем по левому краю */
    margin-top: 1rem;
  }
  .consents-inline .form-check {
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
  }
  .consents-inline .form-check-label {
    margin-left: .4rem;
  }
</style>

<div class="consents-inline">
  <div class="form-check">
    {{ form.consent_pdn }}
    <label class="form-check-label" for="{{ form.consent_pdn.id_for_label }}">
      Я согласен(а) с
      <a href="{% url 'privacy' %}" target="_blank" rel="noopener">обработкой персональных данных</a>
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="consent_offer" name="consent_offer" required>
    <label class="form-check-label" for="consent_offer">
      Я согласен(а) с
      <a href="https://www.drop-delivery.ru/offer/" target="_blank" rel="noopener">публичной офертой</a>
    </label>
  </div>
</div>


<script>
  (function(){
    const pdn = document.getElementById('{{ form.consent_pdn.id_for_label }}') || document.getElementById('id_consent_pdn');
    const offer = document.getElementById('consent_offer');
    const btn = document.getElementById('order-submit');
    function toggleBtn(){ btn.disabled = !(pdn?.checked && offer?.checked); }
    pdn?.addEventListener('change', toggleBtn);
    offer?.addEventListener('change', toggleBtn);
    toggleBtn();
  })();
</script>
{% endblock %}
