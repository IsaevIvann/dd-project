{% extends "core/base.html" %}
{% load widget_tweaks %}
{% block title %}Оставить заявку — Drop & Delivery{% endblock %}
{% block content %}
<div class="row justify-content-center py-5">
  <div class="col-lg-6 col-md-8">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <h2 class="mb-3 text-center fw-bold">Оставить заявку</h2>

        <!-- Баннер зоны работы -->
        <div class="alert alert-info d-flex gap-2 align-items-start rounded-3 mb-4" role="alert">
          <i class="bi bi-geo-alt fs-5"></i>
          <div>
            <strong>Работаем только в Москве и Московской области.</strong><br>
            Также доставляем в/из аэропортов: Шереметьево, Внуково, Домодедово, Жуковский.
          </div>
        </div>

        <form method="post" autocomplete="off" id="orderForm">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <style>
            .form-control::placeholder{color:#9aa6b2;opacity:1}
            .req::after{content:" *"; color:#ef4444; font-weight:600}

            /* --- datetime fake placeholder --- */
            .dtl-wrap{position:relative}
            .dtl-wrap .fake-ph{
              position:absolute;left:12px;top:50%;transform:translateY(-50%);
              color:#9aa6b2;pointer-events:none;transition:opacity .18s ease;font-size:1rem;line-height:1
            }
            .dtl-wrap input.form-control{padding-right:1.9rem}
            .dtl-wrap input[type="datetime-local"]::-webkit-calendar-picker-indicator{
              transform:translateX(-8px);cursor:pointer;
            }
            .dtl-wrap.filled .fake-ph,.dtl-wrap.focused .fake-ph{opacity:0}
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-fields-wrapper,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-text,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-year-field,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-month-field,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-day-field,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-hour-field,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-minute-field,
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]::-webkit-datetime-edit-ampm-field{color:transparent;opacity:0}
            .dtl-wrap:not(.filled):not(.focused) input[type="datetime-local"]{color:transparent}
            .dtl-wrap.filled input[type="datetime-local"]{color:inherit}

            /* invalid UI */
            .is-invalid{border-color:#ef4444 !important; box-shadow:0 0 0 .15rem rgba(239,68,68,.15) !important}
            .invalid-hint{color:#ef4444;font-size:.875rem;margin-top:.25rem;display:none}
            .invalid-hint.show{display:block}

            /* qty */
            .dd-calc .qty{
              display:flex;align-items:center;gap:8px;width:240px;max-width:100%;
              background:#fff;border:1px solid #e5e7eb;border-radius:14px;
              padding:6px;box-shadow:0 1px 2px rgba(0,0,0,.03)
            }
            .dd-calc .qty input{
              border:0;text-align:center;flex:1 1 auto;font-weight:600;font-size:1.05rem;
              padding:.35rem 0;background:transparent;outline:none
            }
            .dd-calc .qty input::-webkit-outer-spin-button,.dd-calc .qty input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
            .dd-calc .qty input[type=number]{-moz-appearance:textfield}
            .dd-calc .qty .qty-btn{
              border:0;background:#f1f5f9;width:36px;height:36px;line-height:36px;border-radius:10px;font-weight:700;font-size:1.1rem;cursor:pointer
            }
            .dd-calc .qty .qty-btn:hover{background:#e2e8f0}

            /* --- согласия одинаковые чекбоксы --- */
            .dd-consents{display:flex;flex-wrap:wrap;gap:1.25rem;justify-content:flex-start;align-items:center;margin-top:1rem}
            .dd-consents .form-check{display:inline-flex;align-items:center;margin:0;padding:0}
            .dd-consents .form-check-label{margin-left:.55rem;line-height:1.25}

            .dd-check{
              --dd-cb-size:18px;
              --dd-cb-color:#2563eb;
              appearance:none;-webkit-appearance:none;-moz-appearance:none;
              width:var(--dd-cb-size);height:var(--dd-cb-size);
              border:2px solid var(--dd-cb-color);border-radius:4px;
              background:#fff;display:inline-grid;place-content:center;
              margin:0;outline:none;cursor:pointer;position:relative;
            }
            .dd-check:focus{box-shadow:0 0 0 .15rem rgba(37,99,235,.2)}
            .dd-check::before{
              content:"";width:10px;height:6px;
              border:2px solid #fff;border-top:0;border-left:0;
              transform:rotate(45deg) scale(0);transform-origin:center;
              transition:transform .12s ease-in-out;
            }
            .dd-check:checked{background:var(--dd-cb-color)}
            .dd-check:checked::before{transform:rotate(45deg) scale(1)}
          </style>

          <div class="row g-3">
            <!-- Контакты -->
            <div class="col-12">
              <label for="id_name" class="form-label req"><i class="bi bi-person-circle"></i> Имя</label>
              {{ form.name|add_class:"form-control"|attr:"placeholder:Иван Иванов"|attr:"required:required"|attr:"aria-required:true" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_phone" class="form-label req"><i class="bi bi-telephone"></i> Телефон</label>
              {{ form.phone|add_class:"form-control"|attr:"placeholder:+7 900 000-00-00"|attr:"required:required"|attr:"aria-required:true" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_email" class="form-label req"><i class="bi bi-envelope"></i> Email</label>
              {{ form.email|add_class:"form-control"|attr:"placeholder:you@example.com"|attr:"type:email"|attr:"required:required"|attr:"aria-required:true" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_telegram" class="form-label"><i class="bi bi-telegram"></i> Telegram</label>
              {{ form.telegram|add_class:"form-control"|attr:"placeholder:@username" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_whatsapp" class="form-label"><i class="bi bi-whatsapp"></i> WhatsApp</label>
              {{ form.whatsapp|add_class:"form-control"|attr:"placeholder:+7 900 000-00-00" }}
            </div>

            <!-- Логистика -->
            <div class="col-12 mt-2">
              <label for="id_pickup_address" class="form-label req"><i class="bi bi-geo-alt"></i> Адрес забора</label>
              {{ form.pickup_address|add_class:"form-control"|attr:"placeholder:Адрес / аэропорт / вокзал"|attr:"id:id_pickup_address"|attr:"required:required"|attr:"aria-required:true" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_pickup_time" class="form-label req"><i class="bi bi-calendar-event"></i> Время забора</label>
              <div class="dtl-wrap" id="wrap_pickup">
                {{ form.pickup_time|add_class:"form-control"|attr:"id:id_pickup_time"|attr:"type:datetime-local"|attr:"required:required"|attr:"aria-required:true" }}
                <span class="fake-ph">дата / время</span>
              </div>
            </div>

            <div class="col-12">
              <label for="id_delivery_address" class="form-label req"><i class="bi bi-geo"></i> Адрес доставки</label>
              {{ form.delivery_address|add_class:"form-control"|attr:"placeholder:Адрес / аэропорт / вокзал"|attr:"id:id_delivery_address"|attr:"required:required"|attr:"aria-required:true" }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_delivery_time" class="form-label req"><i class="bi bi-calendar-event"></i> Время доставки</label>
              <div class="dtl-wrap" id="wrap_delivery">
                {{ form.delivery_time|add_class:"form-control"|attr:"id:id_delivery_time"|attr:"type:datetime-local"|attr:"required:required"|attr:"aria-required:true" }}
                <span class="fake-ph">дата / время</span>
              </div>
            </div>

            <!-- Комментарий -->
            <div class="col-12">
              <label for="id_comment" class="form-label"><i class="bi bi-chat-dots"></i> Комментарий</label>
              {{ form.comment|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:Пожелания, доп.комментарии, особенности багажа и т.п." }}
            </div>
          </div>

          <!-- Согласия: выровнены слева, одинаковые чекбоксы -->
          <div class="dd-consents">
            <div class="form-check">
              {{ form.consent_pdn|add_class:"dd-check" }}
              <label class="form-check-label" for="{{ form.consent_pdn.id_for_label }}">
                Я согласен(а) с <a href="{% url 'privacy' %}" target="_blank" rel="noopener">обработкой персональных данных</a>
              </label>
            </div>
            <div class="form-check">
              <input class="dd-check" type="checkbox" id="consent_offer" name="consent_offer" required>
              <label class="form-check-label" for="consent_offer">
                Я согласен(а) с <a href="https://www.drop-delivery.ru/offer/" target="_blank" rel="noopener">публичной офертой</a>
              </label>
            </div>
          </div>

          <div class="text-center mt-4">
            <button id="order-submit" type="submit" class="btn btn-primary btn-lg w-100 py-2 shadow-sm">
              <i class="bi bi-check-circle"></i> Отправить заявку
            </button>
          </div>

          <div class="mt-3 text-muted small text-center">
            <i class="bi bi-shield-lock"></i> Мы используем данные только для обработки заявки и оказания услуги.
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  /* фикс фейкового placeholder для datetime */
  (function(){
    function hook(wrapId,inputId){
      const wrap=document.getElementById(wrapId);
      const inp=document.getElementById(inputId);
      if(!wrap||!inp)return;
      function refresh(){(inp.value&&inp.value.trim()!=="")?wrap.classList.add('filled'):wrap.classList.remove('filled');}
      inp.addEventListener('focus',()=>wrap.classList.add('focused'));
      inp.addEventListener('blur',()=>wrap.classList.remove('focused'));
      inp.addEventListener('input',refresh);
      inp.addEventListener('change',refresh);
      refresh();
    }
    hook('wrap_pickup','id_pickup_time');
    hook('wrap_delivery','id_delivery_time');
  })();

  /* блокировка кнопки, пока не отмечены обе галочки */
  (function(){
    const offer=document.getElementById('consent_offer');
    const pdn=document.getElementById('{{ form.consent_pdn.id_for_label }}')||document.getElementById('id_consent_pdn');
    const btn=document.getElementById('order-submit');
    function toggleBtn(){btn.disabled=!(offer?.checked&&pdn?.checked);}
    offer?.addEventListener('change',toggleBtn);
    pdn?.addEventListener('change',toggleBtn);
    toggleBtn();
  })();
</script>
{% endblock %}
