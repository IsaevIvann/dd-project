{% extends "core/base.html" %}
{% load widget_tweaks %}
{% block title %}Оставить заявку — Drop & Delivery{% endblock %}
{% block content %}
<div class="row justify-content-center py-5">
  <div class="col-lg-6 col-md-8">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <h2 class="mb-4 text-center fw-bold">Оставить заявку</h2>

        <form method="post" novalidate autocomplete="off" id="orderForm">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <style>
            .form-control::placeholder { color:#9aa6b2; opacity:1; } /* серые плейсхолдеры */
          </style>

          <div class="row g-3">
            <!-- Контакты -->
            <div class="col-12">
              <label for="id_name" class="form-label"><i class="bi bi-person-circle"></i> Имя</label>
              {{ form.name|add_class:"form-control"|attr:"placeholder:Иван Иванов" }}
              {{ form.name.errors }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_phone" class="form-label"><i class="bi bi-telephone"></i> Телефон</label>
              {{ form.phone|add_class:"form-control"|attr:"placeholder:+7 900 000-00-00" }}
              {{ form.phone.errors }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_email" class="form-label"><i class="bi bi-envelope"></i> Email</label>
              {{ form.email|add_class:"form-control"|attr:"placeholder:you@example.com" }}
              {{ form.email.errors }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_telegram" class="form-label"><i class="bi bi-telegram"></i> Telegram</label>
              {{ form.telegram|add_class:"form-control"|attr:"placeholder:@username" }}
              {{ form.telegram.errors }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_whatsapp" class="form-label"><i class="bi bi-whatsapp"></i> WhatsApp</label>
              {{ form.whatsapp|add_class:"form-control"|attr:"placeholder:+7 900 000-00-00" }}
              {{ form.whatsapp.errors }}
            </div>

            <!-- Логистика -->
            <div class="col-12 mt-2">
              <label for="id_pickup_address" class="form-label"><i class="bi bi-geo-alt"></i> Адрес забора</label>
              {{ form.pickup_address|add_class:"form-control"|attr:"placeholder:Адрес / аэропорт / вокзал"|attr:"id:id_pickup_address" }}
              {{ form.pickup_address.errors }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_pickup_time" class="form-label"><i class="bi bi-calendar-event"></i> Время забора</label>
              {{ form.pickup_time|add_class:"form-control"|attr:"placeholder:дата / время"|attr:"id:id_pickup_time" }}
              {{ form.pickup_time.errors }}
            </div>

            <div class="col-12">
              <label for="id_delivery_address" class="form-label"><i class="bi bi-geo"></i> Адрес доставки</label>
              {{ form.delivery_address|add_class:"form-control"|attr:"placeholder:Адрес / аэропорт / вокзал"|attr:"id:id_delivery_address" }}
              {{ form.delivery_address.errors }}
            </div>

            <div class="col-12 col-md-6">
              <label for="id_delivery_time" class="form-label"><i class="bi bi-calendar-event"></i> Время доставки</label>
              {{ form.delivery_time|add_class:"form-control"|attr:"placeholder:дата / время"|attr:"id:id_delivery_time" }}
              {{ form.delivery_time.errors }}
            </div>

            {% if form.items_count %}
            <div class="col-12 col-md-6">
              <label for="id_items_count" class="form-label"><i class="bi bi-suitcase"></i> Единиц багажа</label>
              {{ form.items_count|add_class:"form-control"|attr:"min:1"|attr:"id:id_items_count" }}
              {{ form.items_count.errors }}
            </div>
            {% endif %}

            <!-- Калькулятор -->
            <div class="col-12">
              <div class="dd-calc card border-0 rounded-3 p-3" style="background:#f8fafc;border:1px solid #e5e7eb!important">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-calculator me-2"></i>
                  <strong class="h6 mb-0">Калькулятор заказа</strong>
                </div>

                <div class="row g-3 align-items-center">
                  <div class="col-12 col-md-5">
                    <label class="form-label text-muted small mb-1">Единиц багажа</label>
                    <div class="qty">
                      <button class="qty-btn" type="button" id="itemsMinus" aria-label="Уменьшить">−</button>
                      <input id="order-items" type="number" value="1" min="1" max="99" inputmode="numeric" aria-label="Количество">
                      <button class="qty-btn" type="button" id="itemsPlus" aria-label="Увеличить">+</button>
                    </div>
                  </div>

                  <div class="col-12 col-md-7">
                    <label class="form-label text-muted small mb-1 mb-md-2">Зона (определяется автоматически по адресам)</label>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <span id="zonePill" class="badge rounded-pill bg-success-subtle text-success-emphasis px-3 py-2">Зона 1 (×1.0)</span>
                      <span class="text-muted small" id="zoneNote">по умолчанию</span>
                    </div>
                    <input type="hidden" name="zone_coef" id="zone_coef" value="1.0">
                  </div>

                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center border rounded-3 px-3 py-2 bg-white">
                      <div class="text-muted">Итоговая стоимость</div>
                      <div id="order-total" class="fw-bold">0 ₽</div>
                    </div>
                    <input type="hidden" name="estimated_cost" id="estimated_cost" value="0">
                  </div>
                </div>
              </div>
            </div>

            <!-- Комментарий -->
            <div class="col-12">
              <label for="id_comment" class="form-label"><i class="bi bi-chat-dots"></i> Комментарий</label>
              {{ form.comment|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:Пожелания по времени, приметы места и т.п." }}
              {{ form.comment.errors }}
            </div>
          </div>

          <!-- Согласие -->
          <div class="mt-3">
            <div class="form-check mt-3">
              {{ form.consent_pdn.errors }}
              <label class="form-check-label" for="{{ form.consent_pdn.id_for_label }}">
                {{ form.consent_pdn }} Я согласен(а) с <a href="{% url 'privacy' %}" target="_blank" rel="noopener">обработкой персональных данных</a>
              </label>
            </div>
            {% if form.consent_pdn and form.consent_pdn.errors %}
              <div class="text-danger small mt-1">{{ form.consent_pdn.errors }}</div>
            {% endif %}
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg w-100 py-2 shadow-sm">
              <i class="bi bi-check-circle"></i> Отправить заявку
            </button>
          </div>

          <div class="mt-3 text-muted small text-center">
            <i class="bi bi-shield-lock"></i> Мы используем данные только для обработки заявки и оказания услуги.
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .dd-calc .qty{
    display:flex; align-items:center; gap:8px;
    width:240px; max-width:100%;
    background:#fff; border:1px solid #e5e7eb;
    border-radius:14px; padding:6px; box-shadow:0 1px 2px rgba(0,0,0,.03);
  }
  .dd-calc .qty input{
    border:0; text-align:center; flex:1 1 auto; font-weight:600; font-size:1.05rem;
    padding:.35rem 0; background:transparent; outline:none;
  }
  .dd-calc .qty input::-webkit-outer-spin-button,
  .dd-calc .qty input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .dd-calc .qty input[type=number]{ -moz-appearance:textfield; }
  .dd-calc .qty .qty-btn{
    border:0; background:#f1f5f9; width:36px; height:36px; line-height:36px;
    border-radius:10px; font-weight:700; font-size:1.1rem; cursor:pointer;
  }
  .dd-calc .qty .qty-btn:hover{ background:#e2e8f0; }
</style>

<script>
  /* ===== Основной расчёт стоимости ===== */
  function calcOrderTotal(items, storageDays, zoneK){
    items = Math.max(1, parseInt(items || 1, 10));
    storageDays = Math.max(0, parseInt(storageDays || 0, 10));
    zoneK = parseFloat(zoneK || '1.0');

    // База: 1–3 = 3500; 4–6 = 4000; 7+ = 4500 + 500 за каждую сверх 7-й
    let base;
    if (items <= 3) base = 3500;
    else if (items <= 6) base = 4000;
    else base = 4500 + (items - 7) * 500;

    const baseWithZone = Math.round(base * zoneK);
    const storage = storageDays * 500;          // 1-е сутки бесплатны — учитываем отдельно (storageDays уже без 1-х суток)
    const total = baseWithZone + storage;

    return { base, baseWithZone, storage, total };
  }

  /* ===== Хелперы ===== */
  function parseLocalDateTime(str){
    if(!str) return null;
    let d = null;
    const iso = str.trim().replace(' ', 'T');
    if(!isNaN(Date.parse(iso))) d = new Date(iso);
    if(!d || isNaN(d)) {
      const m = str.match(/(\d{1,2})\.(\d{1,2})\.(\d{4}).*?(\d{1,2}):(\d{2})/);
      if (m){
        const [_, dd, mm, yyyy, HH, MM] = m.map(Number);
        d = new Date(yyyy, mm-1, dd, HH, MM);
      }
    }
    return (d && !isNaN(d)) ? d : null;
  }

  function daysAfterFirstFree(pickup, delivery){
    if(!pickup || !delivery) return 0;
    const ms = delivery - pickup;
    if (ms <= 0) return 0;
    const days = Math.ceil(ms / (24*60*60*1000));
    return Math.max(0, days - 1); // первые сутки бесплатно
  }

  // Простая эвристика зоны без внешних API
  const MOSCOW_MARKERS = [" москва","москва","МКАД","цао","сао","свао","вао","ювао","юао","юзао","зао","сзао","svo","vko","dme","zia","шереметьево","внуково","домодедово","жуковский","вокзал"];
  const MO_TOWNS = ["одинцово","химки","мытищи","люберцы","балашиха","красногорск","королёв","королев","подольск","реутов","видное","долгопрудный","лобня","домодедово","котельники","область","обл."];

  function detectZoneByText(addrPickup, addrDelivery){
    const t = ((addrPickup||"") + " " + (addrDelivery||"")).toLowerCase();
    const inMoscow = MOSCOW_MARKERS.some(k => t.includes(k.toLowerCase()));
    const inMO = MO_TOWNS.some(k => t.includes(k.toLowerCase())) || t.includes("московская область");
    if (inMO && !inMoscow) return 1.5;
    return 1.0;
  }

  function formatRub(n){ return n.toLocaleString('ru-RU') + " ₽"; }

  /* ===== Привязка к форме ===== */
  (function(){
    const itemsInput   = document.getElementById('order-items');
    const itemsPlus    = document.getElementById('itemsPlus');
    const itemsMinus   = document.getElementById('itemsMinus');
    const hiddenItems  = document.getElementById('id_items_count'); // может не быть в форме
    const totalEl      = document.getElementById('order-total');
    const zonePill     = document.getElementById('zonePill');
    const zoneNote     = document.getElementById('zoneNote');
    const zoneCoefInput= document.getElementById('zone_coef');
    const estCostInput = document.getElementById('estimated_cost');

    const pickupAddr   = document.getElementById('id_pickup_address');
    const deliveryAddr = document.getElementById('id_delivery_address');
    const pickupTime   = document.getElementById('id_pickup_time');
    const deliveryTime = document.getElementById('id_delivery_time');

    function syncItems(){ if(hiddenItems) hiddenItems.value = itemsInput.value; }

    function currentZoneK(){
      return detectZoneByText(pickupAddr?.value, deliveryAddr?.value);
    }

    function renderZone(k){
      zoneCoefInput.value = String(k);
      if (k === 1.0){
        zonePill.className = "badge rounded-pill bg-success-subtle text-success-emphasis px-3 py-2";
        zonePill.textContent = "Зона 1 (×1.0)";
        zoneNote.textContent = "по умолчанию";
      } else {
        zonePill.className = "badge rounded-pill bg-warning-subtle text-warning-emphasis px-3 py-2";
        zonePill.textContent = "Зона 1.5 (×1.5)";
        zoneNote.textContent = "определено по адресам";
      }
    }

    function recalc(){
      const k = currentZoneK();
      renderZone(k);

      const pick = parseLocalDateTime(pickupTime?.value);
      const drop = parseLocalDateTime(deliveryTime?.value);
      const storage = daysAfterFirstFree(pick, drop);

      const items = parseInt(itemsInput.value || "1", 10);
      const { total } = calcOrderTotal(items, storage, k);

      totalEl.textContent = formatRub(total);
      estCostInput.value = total;
      syncItems();
    }

    itemsPlus?.addEventListener('click', ()=>{ itemsInput.value = Math.min(99, (parseInt(itemsInput.value||"1",10)+1)); recalc(); });
    itemsMinus?.addEventListener('click', ()=>{ itemsInput.value = Math.max(1,  (parseInt(itemsInput.value||"1",10)-1)); recalc(); });
    itemsInput?.addEventListener('input', recalc);

    [pickupAddr, deliveryAddr, pickupTime, deliveryTime].forEach(el=>{
      el && el.addEventListener('input', recalc);
      el && el.addEventListener('change', recalc);
    });

    recalc(); // первичный расчёт
  })();
</script>
{% endblock %}
