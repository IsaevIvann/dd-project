{% extends "core/base.html" %}
{% load static %}
{% block title %}D&D ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –±–∞–≥–∞–∂–∞ –≤ –ú–æ—Å–∫–≤–µ –∏ –æ–±–ª–∞—Å—Ç–∏{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
  :root{--ink:#0f172a;--muted:#64748b;--r:24px;}
  body{font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;}
  h1,h2,h3,h4{letter-spacing:-0.01em;}
  .pill{border-radius:999px}
  .card-dd{border:0;border-radius:var(--r);box-shadow:0 12px 30px rgba(16,24,40,.08);background:#fff;}
  .hero-clean{border-radius:32px;padding:3.5rem 2rem;background:#fff;box-shadow:0 20px 50px rgba(16,24,40,.06)}
  .hero-ill{border-radius:24px;background:#fff;box-shadow:0 10px 26px rgba(16,24,40,.08)}
  .icon-wrap{width:68px;height:68px;border-radius:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(16,24,40,.06)}
  .icon-blue{background:#e6f0ff;color:#2563eb;}
  .icon-green{background:#e9fff4;color:#0e9f6e;}
  .icon-cyan{background:#e6fcff;color:#0891b2;}
  .icon-amber{background:#fff5e6;color:#f59e0b;}
  .tariff-title{color:var(--muted);}
  .tariff-price{font-size:1.6rem;font-weight:400;line-height:1.3;color:var(--ink);letter-spacing:normal}
  .tariff-price .rub{font-weight:300}
  .tariff-price .period{font-weight:400}
  .tariff-note{color:var(--muted);}
</style>

<!-- HERO -->
<section class="hero-clean mb-5">
  <div class="row align-items-center gy-4">
    <div class="col-lg-7">
      <!-- H1 —Å –∫–ª—é—á–æ–º -->
      <h1 class="fw-bold display-5 mb-3" style="color:var(--ink)">
        –î–æ—Å—Ç–∞–≤–∫–∞ –±–∞–≥–∞–∂–∞ –≤ –ú–æ—Å–∫–≤–µ –∏ –æ–±–ª–∞—Å—Ç–∏ ‚Äî –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–π—Ç–µ <span class="text-primary">–Ω–∞–ª–µ–≥–∫–µ</span>
      </h1>
      <p class="fs-5 text-muted mb-4">
        –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –ø—Ä–∏–µ–¥–µ—Ç, —É–ø–∞–∫—É–µ—Ç –∏ –æ–ø–µ—á–∞—Ç–∞–µ—Ç —á–µ–º–æ–¥–∞–Ω—ã. –ú—ã —Å–æ—Ö—Ä–∞–Ω–∏–º –∏—Ö –Ω–∞ —Å–∫–ª–∞–¥–µ –∏ –ø—Ä–∏–≤–µ–∑—ë–º
        <span class="fw-semibold">–≤ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –≤–∞—Å –º–µ—Å—Ç–æ</span>: –∞—ç—Ä–æ–ø–æ—Ä—Ç, –≤–æ–∫–∑–∞–ª –∏–ª–∏ –æ—Ç–µ–ª—å ‚Äî —Ç–æ—á–Ω–æ –≤ —Å—Ä–æ–∫.
      </p>
      <div class="d-flex flex-wrap gap-3">
        <a href="{% url 'order_create' %}" class="btn btn-lg btn-primary pill px-4"><i class="bi bi-bag-check"></i> –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a>
        <a href="#tariffs" class="btn btn-lg btn-outline-primary pill px-4"><i class="bi bi-tags"></i> –¢–∞—Ä–∏—Ñ—ã</a>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="hero-ill p-4 text-center">
        <img src="{% static 'core/img/dnd-hero.png' %}"
             alt="Drop & Delivery ‚Äî –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –±–∞–≥–∞–∂–∞: –∑–∞–±–æ—Ä, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç–∞–≤–∫–∞. –î–æ—Å—Ç–∞–≤–∏–º –≤ —É–¥–æ–±–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –≤—Ä–µ–º—è!"
             class="img-fluid rounded-4"
             loading="lazy"
             decoding="async">
        <div class="small text-muted mt-2">–í–∞—à –±–∞–≥–∞–∂ ‚Äî –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π –∏ —É–∂–µ –≤ –ø—É—Ç–∏ ‚úàÔ∏è</div>
      </div>
    </div>
  </div>
</section>

<!-- –®–ê–ì–ò -->
<section class="p-4 p-md-5 mb-5" style="border-radius:28px;background:#f7fbff">
  <h3 class="fw-bold text-center mb-4">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —É—Å–ª—É–≥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –±–∞–≥–∞–∂–∞</h3>
  <div class="row row-cols-2 row-cols-md-3 row-cols-xl-5 g-4 justify-content-center">
    <div class="col text-center">
      <div class="icon-wrap icon-blue mx-auto mb-3"><i class="bi bi-pencil-square fs-3"></i></div>
      <h6 class="mb-1">1. –ó–∞—è–≤–∫–∞</h6>
      <div class="text-muted small">–û—Å—Ç–∞–≤–ª—è–µ—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ –∏–ª–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.</div>
    </div>
    <div class="col text-center">
      <div class="icon-wrap icon-green mx-auto mb-3"><i class="bi bi-person-check fs-3"></i></div>
      <h6 class="mb-1">2. –í—Å—Ç—Ä–µ—á–∞</h6>
      <div class="text-muted small">–ü—Ä–∏–µ–∑–∂–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∏ —É–ø–∞–∫–æ–≤–∫–æ–π.</div>
    </div>
    <div class="col text-center">
      <div class="icon-wrap icon-cyan mx-auto mb-3"><i class="bi bi-lock fs-3"></i></div>
      <h6 class="mb-1">3. –û–ø–µ—á–∞—Ç—ã–≤–∞–µ–º</h6>
      <div class="text-muted small">–ü–ª–æ–º–±–∏—Ä—É–µ–º, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–µ–º, –≤—ã–¥–∞—ë–º –∫–≤–∏—Ç–∞–Ω—Ü–∏—é.</div>
    </div>
    <div class="col text-center">
      <div class="icon-wrap icon-amber mx-auto mb-3"><i class="bi bi-geo-alt fs-3"></i></div>
      <h6 class="mb-1">4. –î–æ—Å—Ç–∞–≤–∫–∞</h6>
      <div class="text-muted small">–ü—Ä–∏–≤–æ–∑–∏–º –ø–æ –∞–¥—Ä–µ—Å—É, –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç –∏–ª–∏ –Ω–∞ –≤–æ–∫–∑–∞–ª.</div>
    </div>
    <div class="col text-center">
      <div class="icon-wrap icon-blue mx-auto mb-3"><i class="bi bi-credit-card fs-3"></i></div>
      <h6 class="mb-1">5. –û–ø–ª–∞—Ç–∞</h6>
      <div class="text-muted small">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å ‚Äî –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ.</div>
    </div>
  </div>
</section>

<!-- –¢–ê–†–ò–§–´ + –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† -->
<section id="tariffs" class="mb-5">
  <style>
    .dd-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #d6e4ff;background:#ecf3ff;color:#1e3a8a;font-size:12px}
    .dd-divider{height:1px;background:#eef2ff;margin:8px 0 10px}
    .dd-calc .form-control,.dd-calc .form-select{border-radius:12px;padding:.8rem .9rem;border-color:#e5e7eb}
    .dd-calc .form-control:focus,.dd-calc .form-select:focus{border-color:#2563eb;box-shadow:0 0 0 .35rem rgba(37,99,235,.15)}
    .dd-total{font-weight:800;font-size:1.6rem;color:var(--ink)}
    .dd-muted{color:var(--muted)}
  </style>

  <h3 class="fw-bold text-center mb-4">–¢–∞—Ä–∏—Ñ—ã –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É –±–∞–≥–∞–∂–∞</h3>

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card-dd p-4 h-100 text-center">
        <div class="small tariff-title mb-1">1‚Äì3 –µ–¥–∏–Ω–∏—Ü—ã</div>
        <div class="tariff-price mb-2">–æ—Ç 3 500 <span class="rub">‚ÇΩ</span></div>
        <div class="dd-divider"></div>
        <div class="text-muted small">–ó–∞–±–æ—Ä ‚Üí —Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –¥–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="mt-2"><span class="dd-chip">1 —Å—É—Ç–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã</span></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-dd p-4 h-100 text-center">
        <div class="small tariff-title mb-1">4‚Äì6 –µ–¥–∏–Ω–∏—Ü</div>
        <div class="tariff-price mb-2">–æ—Ç 4 000 <span class="rub">‚ÇΩ</span></div>
        <div class="dd-divider"></div>
        <div class="text-muted small">–ó–∞–±–æ—Ä ‚Üí —Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –¥–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="mt-2"><span class="dd-chip">1 —Å—É—Ç–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã</span></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-dd p-4 h-100 text-center">
        <div class="small tariff-title mb-1">7+ –µ–¥–∏–Ω–∏—Ü</div>
        <div class="tariff-price mb-2">4 500 <span class="rub">‚ÇΩ</span> + 500 ‚ÇΩ/–∑–∞ –∫–∞–∂–¥—É—é –¥–æ–ø. –µ–¥.</div>
        <div class="dd-divider"></div>
        <div class="text-muted small">–ó–∞–±–æ—Ä ‚Üí —Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –¥–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="mt-2"><span class="dd-chip">1 —Å—É—Ç–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
      </div>
    </div>
  </div>

  <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
  <div class="card-dd p-4 p-md-4 mt-4 dd-calc">
    <h5 class="fw-bold mb-3">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –±–∞–≥–∞–∂–∞</h5>
    <form class="row g-3 align-items-end" onsubmit="event.preventDefault(); ddCalc();">
      <div class="col-6 col-md-3">
        <label class="form-label dd-muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü</label>
        <input id="dd-items" type="number" min="1" max="99" value="2" class="form-control" required>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label dd-muted">–î–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è 1-–µ)</label>
        <input id="dd-days" type="number" min="1" max="30" value="1" class="form-control" required>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label dd-muted">–ó–æ–Ω–∞</label>
        <select id="dd-zone" class="form-select">
          <option value="1.0" selected>–ó–æ–Ω–∞ 1 ‚Äî –ú–æ—Å–∫–≤–∞, –≤—Å–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã (√ó1.0)</option>
          <option value="1.5">–ó–æ–Ω–∞ 1.5 ‚Äî –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å (√ó1.5)</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <button class="btn btn-primary w-100 pill" type="submit"><i class="bi bi-calculator"></i> –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
      </div>
    </form>

    <div id="dd-result" class="mt-3" hidden>
      <div class="dd-total" id="dd-total">0 ‚ÇΩ</div>
      <div class="dd-muted small" id="dd-lines"></div>
    </div>
    <div class="dd-muted small mt-2">
      –ë–∞–∑–∞ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–æ–Ω—ã. –•—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –µ–¥–∏–Ω—ã–π —Ç–∞—Ä–∏—Ñ: 1-–µ —Å—É—Ç–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –¥–∞–ª–µ–µ 500 ‚ÇΩ/—Å—É—Ç–∫–∏ –∑–∞ –≤—Å—é –ø–∞—Ä—Ç–∏—é.
    </div>
  </div>

  <!-- –ó–û–ù–´ -->
  <div id="zones" class="mt-4">
    <div class="row g-4 align-items-stretch">
      <!-- –õ–µ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
      <div class="col-lg-6">
        <div class="card-dd p-4 h-100">
          <div class="small text-muted">–ó–æ–Ω–∞ 1</div>
          <div class="h5 fw-bold mb-1">–ú–æ—Å–∫–≤–∞, –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã –∏ –≤–æ–∫–∑–∞–ª—ã</div>
          <div class="text-muted mb-3">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <span class="fw-semibold">√ó1.0</span></div>
          <div class="dd-divider"></div>
          <div class="small text-muted">–ó–æ–Ω–∞ 1.5</div>
          <div class="h5 fw-bold mb-1">–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</div>
          <div class="text-muted">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <span class="fw-semibold">√ó1.5</span></div>
          <div class="small text-muted mt-3">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –±–∞–∑–æ–≤–æ–π —É—Å–ª—É–≥–µ (–∑–∞–±–æ—Ä + –¥–æ—Å—Ç–∞–≤–∫–∞). –•—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –ø–æ –µ–¥–∏–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É.</div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
      <div class="col-lg-6">
        <div class="card-dd p-4 h-100 d-flex flex-column">
          <div class="d-flex align-items-start gap-3 mb-2">
            <div class="emoji-badge">üß≠</div>
            <div>
              <div class="h5 fw-bold mb-1" style="color:var(--ink)">–ù–µ —É–≤–µ—Ä–µ–Ω—ã, –∫ –∫–∞–∫–æ–π –∑–æ–Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∞–¥—Ä–µ—Å?</div>
              <div class="text-muted">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å ‚Äî –º—ã –ø–æ–¥—Å–∫–∞–∂–µ–º –∑–æ–Ω—É –∏ –ø—Ä–∏–º–µ–Ω–∏–º –Ω—É–∂–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
            </div>
          </div>

          <label class="form-label mt-2 dd-muted">–ê–¥—Ä–µ—Å –∏–ª–∏ –º–µ—Å—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–í–Ω—É–∫–æ–≤–æ¬ª, ¬´–û–¥–∏–Ω—Ü–æ–≤–æ¬ª)</label>
          <div class="d-flex gap-2 flex-wrap">
            <input id="zoneAddress" class="form-control flex-grow-1" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
            <button id="detectZone" class="btn btn-primary pill px-4" type="button">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–æ–Ω—É</button>
          </div>

          <div id="zoneResult" class="mt-3"></div>

          <ul class="mt-3 mb-0 text-muted" style="padding-left:1.1rem;">
            <li><strong>–ó–æ–Ω–∞ 1</strong> ‚Äî –ú–æ—Å–∫–≤–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ú–ö–ê–î, –≤—Å–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã –∏ –≤–æ–∫–∑–∞–ª—ã.</li>
            <li><strong>–ó–æ–Ω–∞ 1.5</strong> ‚Äî –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å (–∑–∞ –ú–ö–ê–î).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .emoji-badge{
    width:44px;height:44px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:#eef5ff;font-size:22px;
    box-shadow:0 8px 20px rgba(16,24,40,.06)
  }
  #zones .form-control{border-radius:12px;padding:.8rem .9rem;border-color:#e5e7eb}
  #zones .form-control:focus{border-color:#2563eb;box-shadow:0 0 0 .35rem rgba(37,99,235,.15)}
  #zoneResult .pill{display:inline-block;border-radius:999px;padding:6px 12px;font-weight:600}
  #zoneResult .pill--z1{background:rgba(34,197,94,.14);color:#166534}
  #zoneResult .pill--z15{background:rgba(234,179,8,.16);color:#92400e}
</style>

<!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=–í–ê–®_–ö–õ–Æ–ß" defer></script>

<script>
  /* ====== –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ====== */
  function ddCalc(){
    const items = Math.max(1, parseInt(document.getElementById('dd-items').value || '1', 10));
    const days  = Math.max(1, parseInt(document.getElementById('dd-days').value  || '1', 10));
    const zoneK = parseFloat(document.getElementById('dd-zone').value || '1.0');

    // –¢–∞—Ä–∏—Ñ—ã
    let base = 3500;
    if (items >= 4 && items <= 6) base = 4000;
    else if (items >= 7) base = 4500 + (items - 7) * 500;

    const baseWithZone = Math.round(base * zoneK);
    const storageDays = Math.max(0, days - 1);
    const storageCost = storageDays * 500;
    const total = baseWithZone + storageCost;

    const lines = [
      `–ë–∞–∑–∞ –∑–∞ ${items} –µ–¥.: ${base.toLocaleString('ru-RU')} ‚ÇΩ √ó ${zoneK.toFixed(1)} = <b>${baseWithZone.toLocaleString('ru-RU')} ‚ÇΩ</b>`,
      `–•—Ä–∞–Ω–µ–Ω–∏–µ: 1-–µ —Å—É—Ç–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ + ${storageDays} √ó 500 ‚ÇΩ = <b>${storageCost.toLocaleString('ru-RU')} ‚ÇΩ</b>`
    ];

    document.getElementById('dd-total').innerHTML = `${total.toLocaleString('ru-RU')} ‚ÇΩ`;
    document.getElementById('dd-lines').innerHTML = lines.join('<br>');
    document.getElementById('dd-result').hidden = false;
  }

  /* ====== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–û–ù–´ (–ú–ö–ê–î) ====== */
  (function(){
    const MKAD_POLY = [
      [55.774558,37.842762],[55.76522,37.842789],[55.755723,37.843323],[55.747399,37.843575],[55.739103,37.843513],
      [55.730482,37.843208],[55.721939,37.842819],[55.712203,37.841709],[55.703048,37.840271],[55.694287,37.839005],
      [55.68529,37.836521],[55.675945,37.832779],[55.667752,37.82909],[55.658667,37.824787],[55.650053,37.820278],
      [55.641443,37.815876],[55.63229,37.811191],[55.623655,37.806671],[55.615094,37.802227],[55.606402,37.797878],
      [55.597201,37.793205],[55.587839,37.78854],[55.578834,37.784149],[55.570058,37.78009],[55.561405,37.776127],
      [55.552736,37.772003],[55.544001,37.76804],[55.535073,37.76408],[55.526113,37.758938],[55.517578,37.754311],
      [55.509168,37.74984],[55.500171,37.743828],[55.491469,37.739227],[55.482824,37.734814],[55.474282,37.729515],
      [55.466,37.724747],[55.456507,37.721359],[55.448131,37.719173],[55.439682,37.716888],[55.431333,37.714573],
      [55.4226,37.7131],[55.414925,37.7112],[55.406906,37.7096],[55.398876,37.70789],[55.391009,37.705563],
      [55.38239,37.703026],[55.374578,37.700981],[55.366962,37.697868],[55.358655,37.693508],[55.350843,37.688847],
      [55.34271,37.684071],[55.334482,37.679554],[55.32614,37.675141],[55.317603,37.670696],[55.309003,37.66629],
      [55.300476,37.661877],[55.292293,37.657559],[55.284,37.654106],[55.27556,37.651073],[55.266991,37.648117],
      [55.258385,37.646004],[55.249802,37.643753],[55.241273,37.641293],[55.232799,37.638985],[55.224273,37.636612],
      [55.215759,37.634167],[55.207154,37.631931],[55.198653,37.629635],[55.1901,37.627342],[55.181512,37.625049],
      [55.172985,37.622765],[55.164454,37.620468],[55.155952,37.618175],[55.147415,37.615879],[55.138905,37.613594],
      [55.130386,37.611301],[55.121876,37.609016],[55.113327,37.606716],[55.104809,37.604424],[55.096287,37.602131],
      [55.087772,37.599842],[55.079243,37.597557],[55.070724,37.595264],[55.062199,37.592972],[55.053673,37.590679],
      [55.045143,37.58839],[55.036617,37.586098],[55.028091,37.583805],[55.019566,37.581512],[55.011036,37.579224],
      [55.00251,37.576931],[54.99398,37.574642],[54.985455,37.57235],[54.976929,37.570061],[54.968403,37.567768],
      [54.959877,37.565475],[54.951351,37.563187],[54.942825,37.560894],[54.934299,37.558601],[54.925774,37.556313],
      [54.917248,37.55402],[54.908722,37.551727],[54.900196,37.549438],[54.89167,37.547146],[54.883144,37.544857],
      [54.874619,37.542564],[54.866093,37.540276],[54.857567,37.537983],[54.849041,37.53569],[54.840515,37.533401],
      [54.831989,37.531109],[54.823463,37.52882],[54.814938,37.526527],[54.806412,37.524239],[54.797886,37.521946],
      [54.78936,37.519653],[54.780834,37.517365],[54.772308,37.515072],[54.763782,37.512783],[54.755257,37.51049],
      [54.746731,37.508202],[54.738205,37.505909],[54.729679,37.503616],[54.721153,37.501328],[54.712627,37.499035],
      [54.704102,37.496746],[54.695576,37.494453]
    ];

    const airports = ["—à–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ","–¥–æ–º–æ–¥–µ–¥–æ–≤–æ","–≤–Ω—É–∫–æ–≤–æ","–∂—É–∫–æ–≤—Å–∫–∏–π","svo","dme","vko","zia"];
    const rails = ["–±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π","–∫—É—Ä—Å–∫–∏–π","–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–π","–∫–∏–µ–≤—Å–∫–∏–π","–∫–∞–∑–∞–Ω—Å–∫–∏–π","–ø–∞–≤–µ–ª–µ—Ü–∫–∏–π","—Ä–∏–∂—Å–∫–∏–π","—Å–∞–≤—ë–ª–æ–≤—Å–∫–∏–π","—Å–∞–≤–µ–ª–æ–≤—Å–∫–∏–π","—è—Ä–æ—Å–ª–∞–≤—Å–∫–∏–π","–≤–æ–∫–∑–∞–ª","—Ä–∂–¥"];

    const input = document.getElementById('zoneAddress');
    const btn   = document.getElementById('detectZone');
    const out   = document.getElementById('zoneResult');
    const zoneSelect = document.getElementById('dd-zone');

    function render(res, src){
      out.innerHTML =
        `<span class="pill ${res.val==='1.0'?'pill--z1':'pill--z15'}">${res.zone}</span>
         <span class="ms-2 text-muted">–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ${res.coef}${res.addr ? ` ‚Ä¢ ${res.addr}`:''}${src?` ‚Ä¢ ${src}`:''}</span>`;
      if (zoneSelect) zoneSelect.value = res.val;
    }

    function pointInPolygon(lat, lon, poly){
      let inside = false;
      for (let i=0, j=poly.length-1; i<poly.length; j=i++){
        const xi = poly[i][0], yi = poly[i][1];
        const xj = poly[j][0], yj = poly[j][1];
        const intersect = ((yi>lon)!==(yj>lon)) && (lat < (xj - xi) * (lon - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function fallbackDecide(q){
      const lower = q.toLowerCase();
      const isAirport = airports.some(a => lower.includes(a));
      const isRail    = rails.some(r => lower.includes(r));
      const isMoscow  = /(^|\s)–º–æ—Å–∫–≤[–∞–µ—ã—É]|–º–∫–∞–¥/.test(lower);
      return (isAirport || isRail || isMoscow)
        ? {zone:"–ó–æ–Ω–∞ 1", coef:"√ó1.0", val:"1.0"}
        : {zone:"–ó–æ–Ω–∞ 1.5", coef:"√ó1.5", val:"1.5"};
    }

    function ensureYmapsReady(){
      return new Promise((resolve, reject)=>{
        const start = Date.now();
        function check(){
          if (window.ymaps && ymaps.ready) return ymaps.ready(resolve);
          if (Date.now()-start>8000) return reject(new Error('ymaps timeout'));
          setTimeout(check, 100);
        }
        check();
      });
    }

    async function geocode(q){
      await ensureYmapsReady();
      const result = await ymaps.geocode(q, { results: 1 });
      if (!result || result.geoObjects.getLength()===0) throw new Error('not_found');
      const obj   = result.geoObjects.get(0);
      const coords= obj.geometry.getCoordinates();
      const meta  = obj.properties.get('metaDataProperty') || {};
      const text  = (meta.GeocoderMetaData && meta.GeocoderMetaData.text) || obj.getAddressLine() || q;
      return { coords, text };
    }

    btn.addEventListener('click', async ()=>{
      const q = (input.value||'').trim();
      if (!q){ out.innerHTML = '<span class="text-muted">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å</span>'; return; }

      out.innerHTML = '<span class="text-muted">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—É‚Ä¶</span>';

      try{
        const { coords, text } = await geocode(q);
        const lower = text.toLowerCase();

        if (airports.some(a=>lower.includes(a)) || rails.some(r=>lower.includes(r))){
          render({zone:"–ó–æ–Ω–∞ 1", coef:"√ó1.0", val:"1.0", addr:text}, '–ø–æ –∫–∞—Ä—Ç–∞–º');
          return;
        }

        const inside = pointInPolygon(coords[0], coords[1], MKAD_POLY);
        render(
          inside
            ? {zone:"–ó–æ–Ω–∞ 1", coef:"√ó1.0", val:"1.0", addr:text}
            : {zone:"–ó–æ–Ω–∞ 1.5", coef:"√ó1.5", val:"1.5", addr:text},
          '–ø–æ –∫–∞—Ä—Ç–∞–º'
        );
      }catch(e){
        const fb = fallbackDecide(q);
        render(fb, '—ç–≤—Ä–∏—Å—Ç–∏–∫–∞');
      }
    });
  })();
</script>

<!-- FAQ (—Ç–æ—Ç –∂–µ –∫–æ–Ω—Ç–µ–Ω—Ç, –∏–∑ –æ–±—â–µ–≥–æ include) -->
{% include "core/partials/_faq_block.html" %}

<!-- –ú–∏–Ω–∏-CTA -->
<section class="card-dd p-4 p-md-5 mb-4 text-center">
  <h4 class="fw-bold mb-2">–ü—É—Ç–µ—à–µ—Å—Ç–≤—É–π—Ç–µ –ø–æ –ú–æ—Å–∫–≤–µ –Ω–∞–ª–µ–≥–∫–µ</h4>
  <div class="text-muted mb-3">–ë–∞–≥–∞–∂ ‚Äî –Ω–∞ –Ω–∞—Å. –î–æ—Å—Ç–∞–≤–∏–º —Ç–æ—á–Ω–æ –∫–æ –≤—Ä–µ–º–µ–Ω–∏!</div>
  <a href="{% url 'order_create' %}" class="btn btn-lg btn-primary pill px-4"><i class="bi bi-bag"></i> –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a>
  <div class="mt-3">
    <a href="{% url 'faq' %}" class="btn btn-outline-primary pill px-4">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã</a>
  </div>
</section>
{% endblock %}
